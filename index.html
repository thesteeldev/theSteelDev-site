<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheSteelDev AI Planner</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1e1e1e; --primary: #bb86fc; --text: #e0e0e0; --success: #03dac6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }

        /* Dashboard Grid */
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); }

        /* Floating Add Button */
        .fab { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: #000; width: 60px; height: 60px; border-radius: 50%; font-size: 30px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(187,134,252,0.4); display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }

        /* Project Card Style */
        .project-card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-bar-bg { background: #333; height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }

        /* Checklist Items */
        .task-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #333; }
        .task-item input[type="checkbox"] { transform: scale(1.2); accent-color: var(--success); }
        .task-item.done span { text-decoration: line-through; color: #777; }

        /* Modal (Popup) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box; }
        .ai-toggle { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 15px 0; color: var(--success); font-weight: bold; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-save { background: var(--success); color: #000; }
        .btn-cancel { background: #333; color: white; }

        /* Login Screen */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>üîê SteelDev OS</h1>
        <p>Login to access your workspace</p>
        <button class="btn btn-save" onclick="loginWithGoogle()">Sign in with Google</button>
    </div>

    <div id="dashboard" class="container hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>üöÄ My Projects</h2>
            <button class="btn btn-cancel" onclick="logout()" style="font-size: 12px;">Logout</button>
        </div>

        <div id="projects-list">
            <p style="text-align: center; color: #777;">Loading projects...</p>
        </div>

        <button class="fab" onclick="openModal()">+</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>New Mission</h3>
            <input type="text" id="projTitle" placeholder="Ex: Learn Python, Build Gym Body...">

            <div class="ai-toggle">
                <input type="checkbox" id="aiCheck" checked>
                <label for="aiCheck">‚ú® Generate Roadmap with AI</label>
            </div>

            <div id="loadingAI" style="display:none; color: var(--primary); margin-bottom: 10px;">ü§ñ AI is thinking...</div>

            <button class="btn btn-save" onclick="createProject()">Create</button>
            <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "https://my-journal-new.onrender.com"; // Your NEW Render URLconst firebaseConfig = {
            apiKey: "AIzaSyCh2xTrbOz3F9uZkMeKlr2g7Pk94TkJMd8",  // <--- ‡Æ™‡Æ¥‡Øà‡ÆØ ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ© Firebase Key
            authDomain: "steeldev-journal.firebaseapp.com",
            projectId: "steeldev-journal",
            storageBucket: "steeldev-journal.firebasestorage.app",
            messagingSenderId: "923272289095",
            appId: "1:923272289095:web:289dcf21213c497b808a62"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        let currentUserEmail = "";

        // --- AUTH ---
        function loginWithGoogle() { auth.signInWithPopup(provider); }
        function logout() { auth.signOut(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserEmail = user.email;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadProjects();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        // --- CORE FUNCTIONS ---

        // 1. Create Project (Calls AI if checked)
        async function createProject() {
            const title = document.getElementById('projTitle').value;
            const useAI = document.getElementById('aiCheck').checked;

            if(!title) return alert("Enter a title!");

            document.getElementById('loadingAI').style.display = 'block';
            let tasks = [];

            if (useAI) {
                try {
                    // Call Backend to ask Gemini
                    const res = await fetch(`${API_URL}/generate_roadmap`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ title: title })
                    });
                    const data = await res.json();
                    tasks = data.tasks;
                } catch (e) {
                    alert("AI Error, creating manual project.");
                    tasks = ["Step 1 (Add details)"];
                }
            } else {
                tasks = ["Start Project"];
            }

            // Save Final Project to DB
            await fetch(`${API_URL}/create_project`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user: currentUserEmail,
                    title: title,
                    tasks: tasks,
                    color: getRandomColor()
                })
            });

            closeModal();
            loadProjects(); // Refresh UI
        }

        // 2. Load Projects
        async function loadProjects() {
            const res = await fetch(`${API_URL}/get_projects?user=${currentUserEmail}`);
            const projects = await res.json();

            if (projects.error || !Array.isArray(projects)) {
                console.error("Backend Error:", projects.error);
                return;
            }
            const list = document.getElementById('projects-list');
            list.innerHTML = "";

            projects.forEach(p => {
                // Calculate Checklist HTML
                let tasksHtml = "";
                p.tasks.forEach((t, index) => {
                    const checked = t.done ? "checked" : "";
                    const doneClass = t.done ? "done" : "";
                    tasksHtml += `
                        <div class="task-item ${doneClass}">
                            <input type="checkbox" ${checked} onchange="toggleTask('${p._id}', ${index}, this.checked)">
                            <span>${t.text}</span>
                        </div>`;
                });

                list.innerHTML += `
                    <div class="project-card" style="border-left-color: ${p.color}">
                        <div class="card-header">
                            <h3>${p.title}</h3>
                            <span style="font-size: 20px; font-weight:bold; color: ${p.color}">${p.progress}%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${p.progress}%; background: ${p.color}"></div>
                        </div>
                        <div class="tasks-container">
                            ${tasksHtml}
                        </div>
                    </div>
                `;
            });
        }

        // 3. Update Task Status
        async function toggleTask(projectId, taskIndex, isDone) {
            await fetch(`${API_URL}/update_task`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    project_id: projectId,
                    task_index: taskIndex,
                    is_done: isDone
                })
            });
            loadProjects(); // Refresh to update progress bar
        }

        // Utils
        function openModal() { document.getElementById('modal').style.display = 'flex'; document.getElementById('loadingAI').style.display = 'none'; document.getElementById('projTitle').value = ""; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function getRandomColor() { const colors = ['#ff7597', '#bb86fc', '#03dac6', '#ffb74d']; return colors[Math.floor(Math.random() * colors.length)]; }
    </script>
</body>
</html>